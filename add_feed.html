
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Add Feed</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Nunito', sans-serif; background: #f3fbf4; padding: 2rem; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.3rem; font-weight: 600; }
    input, select { width: 100%; padding: 0.5rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; }
    button { padding: 0.6rem 1rem; margin-right: 0.5rem; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; }
    .btn-submit { background-color: #2e7d32; color: white; }
    .btn-calc { background-color: #42a5f5; color: white; }
    .output { margin-top: 1rem; font-size: 1.1rem; font-weight: bold; }
  </style>
</head>
<body>

<a href="dashboard.html" style="display:inline-block;margin-bottom:1rem;padding:0.5rem 1rem;background:#2e7d32;color:#fff;border-radius:8px;text-decoration:none;font-weight:bold;">⬅️ Go to Dashboard</a>
<h2>Add Feed Entry</h2>

<div class="form-group">
  <label>Date</label>
  <input type="date" id="dateInput" />
</div>

<div class="form-group">
  <label>Feed Number</label>
  <input type="number" id="feedNumber" />
</div>

<div class="form-group">
  <label>Ingredient</label>
  <input list="ingredientList" id="ingredientInput" placeholder="Select or type new" />
  <datalist id="ingredientList"></datalist>
</div>

<div class="form-group">
  <label>Quantity</label>
  <input type="number" id="quantityInput" />
</div>

<div class="form-group">
  <label>Unit</label>
  <input type="text" id="unitInput" placeholder="e.g., gm, ml" />
</div>

<div class="form-group">
  <label>Calories (per unit)</label>
  <input type="number" id="caloriesInput" />
</div>

<div class="form-group">
  <label>Protein (per unit)</label>
  <input type="number" id="proteinInput" />
</div>

<div>
  <button class="btn-calc" onclick="calculateFeed()">Calculate</button>
  <button class="btn-submit" onclick="submitFeed()">Submit Feed</button>
</div>

<div class="output" id="calcResult"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAsSdKm43H4dyjKGHtTN6ahwH6RwVcSdYo",
    authDomain: "nutritrack-12b26.firebaseapp.com",
    projectId: "nutritrack-12b26",
    storageBucket: "nutritrack-12b26.appspot.com",
    messagingSenderId: "1034235028376",
    appId: "1:1034235028376:web:ce52c8ca6d1e6a993141ed"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const ingredientMap = {};

  auth.onAuthStateChanged(user => {
    if (!user) return location.href = "index.html";
    loadIngredients();
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("dateInput").value = today;
  });

  function loadIngredients() {
    db.collection("ingredients").get().then(snapshot => {
      const list = document.getElementById("ingredientList");
      snapshot.forEach(doc => {
        const d = doc.data();
        ingredientMap[d.item.toLowerCase()] = { calories: +d.calories, protein: +d.protein, unit: d.unit || "" };
        const opt = document.createElement("option");
        opt.value = d.item;
        list.appendChild(opt);
      });
    });
  }

  document.getElementById("ingredientInput").addEventListener("change", e => {
    const name = e.target.value.trim().toLowerCase();
    if (ingredientMap[name]) {
      const i = ingredientMap[name];
      document.getElementById("caloriesInput").value = i.calories;
      document.getElementById("proteinInput").value = i.protein;
      document.getElementById("unitInput").value = i.unit;
    }
  });

  function calculateFeed() {
    const qty = parseFloat(document.getElementById("quantityInput").value) || 0;
    const cal = parseFloat(document.getElementById("caloriesInput").value) || 0;
    const pro = parseFloat(document.getElementById("proteinInput").value) || 0;
    const result = `Total: ${qty * cal} kcal | ${qty * pro} g protein`;
    document.getElementById("calcResult").textContent = result;
  }

  function submitFeed() {
    const date = document.getElementById("dateInput").value;
    const feed_number = parseInt(document.getElementById("feedNumber").value);
    const item = document.getElementById("ingredientInput").value.trim();
    const quantity = parseFloat(document.getElementById("quantityInput").value);
    const unit = document.getElementById("unitInput").value.trim();
    const calories = parseFloat(document.getElementById("caloriesInput").value);
    const protein = parseFloat(document.getElementById("proteinInput").value);

    if (!date || !feed_number || !item || isNaN(quantity) || isNaN(calories) || isNaN(protein)) {
      alert("Please fill all required fields.");
      return;
    }

    auth.onAuthStateChanged(user => {
      if (!user) return;
      db.collection("feeds").add({
        uid: user.uid,
        date,
        feed_number,
        item,
        quantity,
        unit,
        calories: calories * quantity,
        protein: protein * quantity
      }).then(() => {
        alert("Feed saved!");
        location.href = "dashboard.html";
      });
    });
  }
</script>
</body>
</html>
